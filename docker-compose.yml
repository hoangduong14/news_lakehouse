version: '3.8'

services:
  # ============ MinIO ============
  minio:
    image: minio/minio
    container_name: minio
    ports:
      - "9000:9000"  # S3 endpoint
      - "9001:9001"  # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

  # ============ Zookeeper ============
  zookeeper:
    image: bitnami/zookeeper:3.9
    container_name: zookeeper
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    ports:
      - "2181:2181"

  # ============ Kafka ============
  kafka:
    image: bitnami/kafka:3.7
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true

  # ============ Spark Master ============
  spark:
    image: apache/spark:3.5.0
    container_name: spark
    environment:
      - SPARK_MODE=master
      - SPARK_NO_DAEMONIZE=true
    ports:
      - "7077:7077"   # Spark master
      - "8081:8081"   # Spark UI
    volumes:
      - ./spark_jobs:/opt/app/spark_jobs
      - ./schema.py:/opt/app/schema.py
      - ./create_gold_tables.py:/opt/app/create_gold_tables.py
      - ./collector:/opt/app/collector

  # ============ Spark Worker ============
  spark-worker:
    image: apache/spark:3.5.0
    container_name: spark-worker
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark:7077
    depends_on:
      - spark

  # ============ Trino ============
  trino-coordinator:
    image: trinodb/trino:latest
    container_name: trino-coordinator
    ports:
      - "8080:8080"
    volumes:
      - ./trino-catalog:/etc/trino/catalog
    command: trino-server run
    depends_on:
      - minio

  trino-worker:
    image: trinodb/trino:latest
    container_name: trino-worker
    depends_on:
      - trino-coordinator
    command: trino-server run

  # ============ Superset ============
  superset:
    image: apache/superset:latest
    container_name: superset
    ports:
      - "8088:8088"
    environment:
      SUPERSET_ENV: production
      SUPERSET_LOAD_EXAMPLES: "no"
      SUPERSET_HOME: /app/superset_home
    volumes:
      - ./superset_home:/app/superset_home
      - ./superset_setup.sh:/app/superset_setup.sh
    command: /bin/bash -c "/app/superset_setup.sh && superset run -p 8088 --with-threads --reload --debugger"
    depends_on:
      - trino-coordinator

volumes:
  minio_data:
  superset_home: